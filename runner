#!/bin/bash

if ( ! command -v scrapy >/dev/null ); then
    echo "Please source the environment which installed scrapy"
    exit 1
fi

tmpfile=$(mktemp)

function run_crawler() {
    echo "Crawling $1 spider"
    scrapy crawl $1 2>> $tmpfile
    grep 'KeyError: ' $tmpfile || true
    grep ERROR: $tmpfile || true
}

SPIDER=$1
pushd vnw/vnw/spiders/ >/dev/null
if [ ! -z $SPIDER ]; then
    run_crawler $SPIDER
else
    for spider in *.py; do
        spider_name=$(basename $spider)
        SPIDER=${spider_name/.py/}
        run_crawler $SPIDER
    done
fi

popd >/dev/null

if [ "$(wc -l $tmpfile | cut -d' ' -f1)" -eq 0 ]; then
    rm -f $tmpfile
    exit 0
else
    rm -f $tmpfile
    exit 1
fi
